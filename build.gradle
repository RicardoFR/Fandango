plugins {
  id "java"
  id "application"
  id "net.ltgt.apt-eclipse" version "0.21"
  id "net.ltgt.apt-idea" version "0.21"
  id "com.github.johnrengelman.shadow" version "5.1.0"
  id "io.spring.dependency-management" version "1.0.6.RELEASE"
  id 'org.hidetake.swagger.generator' version '2.18.1'
}

apply plugin: 'java'
apply plugin: 'idea'

group 'es.fandango'
version '1.0-SNAPSHOT'

mainClassName = "es.fandango.MicronautApp"

repositories {
  mavenLocal()
  mavenCentral()
  maven { url "https://jcenter.bintray.com" }
}

dependencyManagement {
  imports {
    mavenBom "io.micronaut:micronaut-bom:$micronautVersion"
  }
}

dependencies {

  swaggerUI 'org.webjars:swagger-ui:3.10.0'

  runtime "ch.qos.logback:logback-classic:$logbackClassicVersion"

  compile "io.micronaut:micronaut-inject-java:$micronautVersion"
  compile "io.micronaut:micronaut-inject:$micronautVersion"
  compile "io.micronaut:micronaut-http-server-netty:$micronautVersion"
  compile "io.micronaut:micronaut-validation:$micronautVersion"
  compile "io.micronaut:micronaut-runtime:$micronautVersion"
  compile "io.micronaut:micronaut-management:$micronautVersion"
  compile "io.micronaut.configuration:micronaut-mongo-reactive:$micronautMongoVersion"
  compile "io.micronaut.test:micronaut-test-junit5:$micronautTestVersion"

  compile "org.projectlombok:lombok:$lombokVersion"
  compile "javax.annotation:javax.annotation-api:$javaxVersion"
  compile "commons-io:commons-io:$commonsioVersion"
  compile "org.junit.jupiter:junit-jupiter-engine:$junitVersion"
  compile "org.junit.jupiter:junit-jupiter-api:$junitVersion"
  compile "io.swagger.core.v3:swagger-annotations"
  compile "ch.qos.logback:logback-classic:1.2.3"

  annotationProcessor "org.projectlombok:lombok:$lombokVersion"
  annotationProcessor "io.micronaut:micronaut-inject-java:$micronautVersion"
  annotationProcessor "io.micronaut:micronaut-validation:$micronautVersion"
  annotationProcessor "io.micronaut.configuration:micronaut-openapi"

  testCompile "de.flapdoodle.embed:de.flapdoodle.embed.mongo:$embedmongoVersion"
  testCompile "org.projectlombok:lombok:$lombokVersion"
  testCompile "io.micronaut:micronaut-inject-java:$micronautVersion"
  testCompile "io.micronaut:micronaut-inject:$micronautVersion"

  testAnnotationProcessor "org.projectlombok:lombok:$lombokVersion"
  testAnnotationProcessor "io.micronaut:micronaut-inject-java:$micronautVersion"
  testAnnotationProcessor "io.micronaut:micronaut-validation:$micronautVersion"
}


swaggerSources {
  app {
    inputFile = file("$buildDir/classes/java/main/META-INF/swagger/fandango-latest.yml")
    ui {
      outputDir = file("$buildDir/classes/java/main/META-INF/swagger-ui")
    }
    reDoc {
      outputDir = file("$buildDir/classes/java/main/META-INF/redoc")
      scriptSrc = "https://cdn.jsdelivr.net/npm/redoc@next/bundles/redoc.standalone.js"
    }
    code {
      language = 'html'  // html or html2
    }
  }
}

jar.finalizedBy(generateSwaggerUI)

run.jvmArgs('-noverify', '-XX:TieredStopAtLevel=1')

tasks.withType(JavaCompile) {
  options.encoding = "UTF-8"
  options.compilerArgs.add('-parameters')
}

shadowJar {
  mergeServiceFiles()
}

// use JUnit 5 platform
test {
  useJUnitPlatform()
}

shadowJar {
  mergeServiceFiles()
}